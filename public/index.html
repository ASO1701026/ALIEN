<!-- 複数人のビデオチャット -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  <!--    <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, user-scale=no, maximum-scale=0.35, minimum-scale=0.35">
  <title>SkyWay - Room example</title>
  <link rel="stylesheet" href="./stylesheets/style.css">
</head>

<body onload="getDeviceList()">
  <div class="container">
    <!--
      <h1 class="heading">Room example</h1>
      <p class="note">
        Change Room mode (before join in a room):
        <a href="#"></a> / <a href="#sfu">sfu</a>
      </p>
    -->
    <!-- ルーム表示 -->
    <div class="room">
      <!-- 相手の -->
      <!---
      <div class="remote-streams" id="js-remote-streams"></div>
      <div class="remote-streams" id="js-remote-streams0" id="js-remote-streams1" id="js-remote-streams2">
        <video class="local-video" id="js-local-stream"></video>
      </div>
      <div>
        <video class="local-video" id="js-local-stream"></video>
         <span id="js-room-mode"></span>
      </div>
      <div class="room">
        <div id = "container">
          <video id="js-local-stream"  style="transform: scaleX(-1);"></video>
          
          <span id="js-room-mode"></span>:
          <input type="text" placeholder="Room Name" id="js-room-id">
          <button id="js-join-trigger">Join</button>
          <button id="js-leave-trigger">Leave</button>
          <button id="js-toggle-camera">カメラON</button>      
          <button id="js-toggle-microphone">マイクON</button>
          <br>
        </div>
      </div>
      <!- テスト用にどのデバイスを有効化しているか表示 -->
      <!-- ↓ここから-->
      <select id="mic_list" size="1" style="width:160pt;">
        <option>(audio)</option>
      </select>
      <select id="speaker_list" size="1" style="width:160pt;">
        <option>(speaker)</option>
      </select>
      <!-- ↑ここまでをコメントアウトで非表示にできる -->
      <button id="speaker_OFF" onclick="clickSwitch()" style="display: block">スピーカーOFF</button>
      <button id="speaker_ON" onclick="clickSwitch()" style="display: none">スピーカーON</button>
      <!-- <button class="sp-mode" style="display:none;">スマートフォン用で表示</button>
           <button class="pc-mode" style="display:none;">PC用で表示</button> -->
    </div>


  </div>
  <p></p>
  <!-- ルーム検索 -->
  <div>
    <input type="text" placeholder="Room Name" id="js-room-id">
    <!-- ルームに接続 -->
    <button id="js-join-trigger">Join</button>
    <button id="js-leave-trigger">Leave</button>
    <button id="js-share-trigger">share</button>
    <br>
     <button id="js-toggle-camera">カメラON</button>
     <button id="js-toggle-microphone">マイクON</button>
     <br>
    
    <!-- テスト用にどのデバイスを有効化しているか表示 -->
    
    <!-- ↓ここから-->
     <select id="mic_list" size="1" style="width:160pt;">
       <option>(audio)</option>
       </select>
     <select id="speaker_list" size="1" style="width:160pt;">
       <option>(speaker)</option>
       </select>
    
    <!-- ↑ここまでをコメントアウトで非表示にできる -->
     <button id="speaker_OFF" onclick="clickSwitch()" style="display: block">スピーカーOFF</button>
     <button id="speaker_ON" onclick="clickSwitch()" style="display: none">スピーカーON</button>
    
    <!-- <button class="sp-mode" style="display:none;">スマートフォン用で表示</button>
          <button class="pc-mode" style="display:none;">PC用で表示</button> -->
  </div>
  </div>

  <!--        
    <div>
          <pre class="messages" id="js-messages"></pre>
          <input type="text" id="js-local-text"></input>
          <button id="js-send-trigger">Send</button>
        </div>
-->

  <p class="meta" id="js-meta"></p>

  </div> <!-- container -->
  <script>
    var micList = document.getElementById("mic_list");
    var speakerList = document.getElementById("speaker_list");

    function clearDeviceList() {
      while (micList.lastChild) {
        micList.removeChild(micList.lastChild);
      }
      while (speakerList.lastChild) {
        speakerList.removeChild(speakerList.lastChild);
      }
    }

    //スピーカーテスト
    //const [{ deviceId }] = devices.filter(device => device.kind === 'audiooutput');
    //スピーカーとマイクを検出
    function getDeviceList() {
      clearDeviceList();
      navigator.mediaDevices.enumerateDevices()
        .then(function (devices) {
          devices.forEach(function (device) {
            console.log(device.kind + ": " + device.label +
              " id = " + device.deviceId);
            addDevice(device);
          });
        })
        .catch(function (err) {
          console.error('enumerateDevide ERROR:', err);
        });
    }

    function addDevice(device) {
      if (device.kind === 'audioinput') {
        var id = device.deviceId;
        var label = device.label || 'microphone'; // label is available for https 
        var option = document.createElement('option');
        option.setAttribute('value', id);
        option.innerHTML = label + '(' + id + ')';;
        micList.appendChild(option);
      }
      else if (device.kind === 'audiooutput') {
        var id = device.deviceId;
        var label = device.label || 'speaker'; // label is available for https 

        var option = document.createElement('option');
        option.setAttribute('value', id);
        option.innerHTML = label + '(' + id + ')';
        speakerList.appendChild(option);
      }
      else {
        console.error('UNKNOWN Device kind:' + device.kind);
      }
    }
    function getSelectedAudio() {
      var audioId = micList.options[micList.selectedIndex].value;
      console.log('selected audioID =' + audioId);
      var constraints = {
        audio: {
          deviceId: audioId
        }
      };
      console.log('mediaDevice.getMedia() constraints:', constraints);

      navigator.mediaDevices.getUserMedia(
        constraints
      ).then(function (stream) {
        localStream = stream;
        logStream('selectedVideo', stream);
        localVideo.srcObject = stream;
      }).catch(function (err) {
        console.error('getUserMedia Err:', err);
      });
    }

    function getSelectedSpeaker() {
      var speakerId = speakerList.options[speakerList.selectedIndex].value;
      localVideo.volume = 0;
      localVideo.setSinkId(speakerId)
        .then(function () {
          console.log('setSinkID Success');
        })
        .catch(function (err) {
          console.error('setSinkId Err:', err);
        });
    }
    function clickSwitch() {
      if (micList.selectedIndex == 1) {
        document.getElementById('speaker_ON').style.display = "none";
        document.getElementById('speaker_OFF').style.display = "block";
        // speakerList.selectedIndex = 0;
      }
      else {
        document.getElementById('speaker_OFF').style.display = "none";
        document.getElementById('speaker_ON').style.display = "block";
        micList.selectedIndex = 1;
        //  speakerList.selectedIndex = 1;
      }
    }
//
